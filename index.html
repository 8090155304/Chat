<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Local Storage Chat</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; }
        #chat-container { max-width: 600px; margin: 30px auto; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; height: 80vh; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: scroll; border-bottom: 1px solid #eee; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 80%; }
        .local-message { background-color: #dcf8c6; margin-left: auto; text-align: right; }
        .remote-message { background-color: #e5e5ea; margin-right: auto; text-align: left; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px; outline: none; }
        #send-button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 20px; cursor: pointer; transition: background-color 0.3s; }
        #send-button:hover { background-color: #45a049; }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="messages">
        </div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // ⚠️ 1. APNI FIREBASE CONFIGURATION YAHAN DALEIN
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Firebase initialize karein
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const chatCollection = db.collection("chats");

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const LOCAL_STORAGE_KEY = 'chatHistory';
    const USER_ID = 'user-' + Math.random().toString(36).substring(2, 9); // Ek simple unique user ID

    // =========================================================================
    // 2. Local Storage (Chat History Fetch Karna)
    // =========================================================================

    function loadLocalHistory() {
        const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
        console.log(`Local History loaded: ${history.length} messages`);
        history.forEach(displayMessage);
        scrollToBottom();
    }

    function saveToLocalHistory(messageData) {
        const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
        history.push(messageData);
        // Sirf latest 50 messages hi save karein
        if (history.length > 50) history.shift(); 
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
    }

    // =========================================================================
    // 3. UI Helper Functions
    // =========================================================================

    function displayMessage(data, isRealTime = false) {
        // Prevent duplicate display if coming from both local and real-time listener
        if (isRealTime && document.getElementById(data.id)) return;

        const messageElement = document.createElement('div');
        messageElement.id = data.id || `temp-${Date.now()}`;
        messageElement.classList.add('message');
        
        // Agar message humare user ID ka hai to 'local' class lagao
        if (data.userId === USER_ID) {
            messageElement.classList.add('local-message');
            messageElement.textContent = `You: ${data.text}`;
        } else {
            messageElement.classList.add('remote-message');
            messageElement.textContent = `Other: ${data.text}`;
        }
        
        messagesDiv.appendChild(messageElement);
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // =========================================================================
    // 4. Real-Time Firebase Functions
    // =========================================================================

    // Message Bhejna
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (text === '') return;

        const messageData = {
            id: Date.now().toString(), // Simple unique ID
            userId: USER_ID,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Real-time timestamp
        };

        try {
            // Firebase me save karein
            await chatCollection.doc(messageData.id).set(messageData);
            
            // Local me save karein (optional, par requested)
            saveToLocalHistory(messageData);
            
            messageInput.value = '';
            scrollToBottom();

        } catch (error) {
            console.error("Error sending message: ", error);
            alert("Message bhejte samay error hui.");
        }
    }

    // Real-time Listener (Dusre users ke messages sunna)
    function startRealtimeListener() {
        chatCollection.orderBy('timestamp').limit(50).onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                
                if (change.type === "added") {
                    // Naye message ko UI par dikhayein
                    displayMessage(data, true);
                    
                    // Naye message ko Local me save karein (agar wo humne nahi bheja hai)
                    if (data.userId !== USER_ID) {
                       saveToLocalHistory(data);
                    }
                    
                    scrollToBottom();
                }
            });
        }, error => {
            console.error("Realtime listener error:", error);
        });
    }

    // =========================================================================
    // 5. Initialize
    // =========================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Site open hone par local history load karein
        loadLocalHistory();

        // Real-time sunna shuru karein
        startRealtimeListener();

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });

</script>

</body>
</html>