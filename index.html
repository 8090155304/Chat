<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Local Data Chat (Netlify + Firebase)</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; }
        #chat-container { max-width: 600px; margin: 30px auto; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; height: 80vh; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: scroll; border-bottom: 1px solid #eee; scroll-behavior: smooth; /* Smooth scrolling ke liye */ }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 18px; max-width: 80%; line-height: 1.4; font-size: 14px; }
        
        /* Message Styling */
        .local-message { 
            background-color: #dcf8c6; 
            margin-left: auto; 
            text-align: right; 
            border-bottom-right-radius: 4px; /* Apna message */
        }
        .remote-message { 
            background-color: #e5e5ea; 
            margin-right: auto; 
            text-align: left; 
            border-bottom-left-radius: 4px; /* Dusra message */
        }
        
        #input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px; outline: none; transition: border-color 0.3s; }
        #message-input:focus { border-color: #4CAF50; }
        #send-button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 20px; cursor: pointer; transition: background-color 0.3s; }
        #send-button:hover { background-color: #45a049; }
        
        .user-id-display {
            font-size: 12px;
            color: #777;
            margin-top: -5px;
            margin-bottom: 5px;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="chat-container">
    <div class="user-id-display">Your ID: <span id="current-user-id"></span></div>
    <div id="messages">
        </div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="Apna message likhein..." autocomplete="off">
        <button id="send-button">Bhejein</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // =========================================================================
    // 1. FIREBASE CONFIGURATION (Zaroori: Apni keys yahan daalein)
    // =========================================================================
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // Apni API key daalein
        authDomain: "YOUR_AUTH_DOMAIN", // Apne domain ka naam daalein
        projectId: "YOUR_PROJECT_ID", // Apne project ID daalein
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Firebase initialize karein
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const chatCollection = db.collection("chats"); // Firestore collection ka naam

    // =========================================================================
    // 2. USER ID AUR LOCAL DATA MANAGEMENT
    // =========================================================================

    // Function: User ID ko localStorage se fetch ya naya ID generate karna
    function getUserId() {
        let userId = localStorage.getItem('chatUserId');
        if (!userId) {
            // Agar ID nahi mili, toh naya banao aur save karo
            userId = 'user-' + Math.random().toString(36).substring(2, 9);
            localStorage.setItem('chatUserId', userId);
        }
        return userId;
    }

    const USER_ID = getUserId(); // Ab yeh ID har baar same rahegi uss device par

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const LOCAL_STORAGE_KEY = 'chatHistory';

    // Local History Load Karna
    function loadLocalHistory() {
        // Site open hone par local data (device mein save ki gayi chats) load karein
        const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
        history.forEach(data => displayMessage(data, false)); // false = Local data, not real-time
        scrollToBottom();
    }

    // Local History Save Karna
    function saveToLocalHistory(messageData) {
        const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
        // Firebase se aane wale data me timestamp object hota hai, jise hume string me convert karna padega
        const dataToSave = { 
            ...messageData, 
            timestamp: messageData.timestamp ? new Date(messageData.timestamp.seconds * 1000).toISOString() : new Date().toISOString()
        };
        history.push(dataToSave);
        // Latest 50 messages hi save karein
        if (history.length > 50) history.shift(); 
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
    }

    // =========================================================================
    // 3. UI AUR RENDERING FUNCTIONS
    // =========================================================================

    function displayMessage(data, isRealTime = false) {
        // Agar message local history se aa raha hai aur uska ID pehle se hi real-time listener ne add kar diya hai, toh skip karein
        if (document.getElementById(`msg-${data.id}`)) return;

        const messageElement = document.createElement('div');
        messageElement.id = `msg-${data.id || Date.now()}`;
        messageElement.classList.add('message');
        
        let senderText = '';
        
        // Agar message humare user ID ka hai to 'local' class lagao
        if (data.userId === USER_ID) {
            messageElement.classList.add('local-message');
            senderText = 'Aap';
        } else {
            messageElement.classList.add('remote-message');
            // Hum dusre user ka poora ID nahi dikha rahe hain, bas "Doosra User" likh rahe hain
            senderText = 'Doosra User'; 
        }
        
        // Message Content
        messageElement.innerHTML = `<strong>${senderText}:</strong> ${data.text}`;
        
        messagesDiv.appendChild(messageElement);
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // =========================================================================
    // 4. REAL-TIME FIREBASE FUNCTIONS
    // =========================================================================

    // Message Bhejna
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (text === '') return;

        const messageData = {
            id: Date.now().toString(), // Simple unique ID
            userId: USER_ID,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Real-time timestamp
        };

        try {
            // 1. Firebase (Real-time database) me save karein
            await chatCollection.doc(messageData.id).set(messageData);
            
            // Input field clear karein
            messageInput.value = '';

        } catch (error) {
            console.error("Message bhejte samay error hui: ", error);
            alert("Message bhejte samay error hui. Firebase configuration check karein.");
        }
    }

    // Real-time Listener (Dusre users ke messages sunna aur unhe local me save karna)
    function startRealtimeListener() {
        // Last 50 messages timestamp ke hisaab se order karke sunna shuru karein
        chatCollection.orderBy('timestamp').limit(50).onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                
                if (change.type === "added") {
                    // 1. Naye message ko UI par dikhayein
                    displayMessage(data, true);
                    
                    // 2. Naye message ko Local me bhi save karein
                    saveToLocalHistory(data);
                    
                    scrollToBottom();
                }
            });
        }, error => {
            console.error("Realtime listener error:", error);
            // Agar network nahi hai, toh yeh error de sakta hai
        });
    }

    // =========================================================================
    // 5. INITIALIZE AUR EVENT LISTENERS
    // =========================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Apna persistent ID display karein
        document.getElementById('current-user-id').textContent = USER_ID;

        // Site open hone par local history load karein
        loadLocalHistory();

        // Real-time sunna shuru karein
        startRealtimeListener();

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });

</script>

</body>
</html>
